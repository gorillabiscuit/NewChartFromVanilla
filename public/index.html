<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Loan Visualization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <select id="walletSelect" class="wallet-selector">
        <option value="">Select a wallet...</option>
    </select>
    <div class="app">
        <button id="imageToggle" class="toggle-button">Show Images</button>
        <div class="chart-wrapper">
            <canvas id="canvas"></canvas>
            <div id="tooltip"></div>
        </div>
        <div id="no-data-message" style="display: none;">No valid loans found for this wallet.</div>
    </div>

    <script type="module">
        import { EventManager } from './event/EventManager.js';
        import { animate } from './animation.js';
        import { state, clearChart } from './state.js';
        import { setupImageToggle, setupResponsiveCanvas } from './uiManager.js';
        import { fetchLoanData, loadBubbleImages } from './dataService.js';
        import { findClusters, bubblesOverlap } from './clusterUtils.js';
        import { createLoanBubbleFromAPI } from './bubbleUtils.js';

        // --- DOM and Canvas Setup ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const imageToggle = document.getElementById('imageToggle');
        const noDataMessage = document.getElementById('no-data-message');

        // --- Constants ---
        const PROTOCOL_COLORS = {
            'Protocol A': '#FF6B6B',
            'Protocol B': '#4ECDC4',
            // Add more protocol colors as needed
        };
        const DEFAULT_PROTOCOL_COLOR = '#6C5CE7';
        const BASE_VELOCITY = 0.2;
        const VELOCITY_POWER = 0.9;
        const WALLETS = ['0x123...', '0x456...']; // Add your wallet addresses

        // --- Setup UI Components ---
        const cleanupImageToggle = setupImageToggle(imageToggle);
        const cleanupCanvas = setupResponsiveCanvas(canvas, ctx);

        // --- Initial Data Load ---
        async function loadInitialData() {
            const data = await fetchLoanData(WALLETS[0]);
            if (data?.data?.length > 0) {
                state.update({
                    allBubbles: [],
                    clusters: [],
                    singleBubbles: []
                });

                // Process loan data
                const processedData = data.data.map(loan => 
                    createLoanBubbleFromAPI(loan, state)
                ).filter(Boolean);

                // Update state with processed data
                state.update({
                    allBubbles: processedData
                });

                // Find clusters
                const clusters = findClusters(
                    processedData,
                    bubblesOverlap,
                    VELOCITY_POWER,
                    BASE_VELOCITY
                );

                // Update state with clusters
                state.update({
                    clusters: clusters.clusters,
                    singleBubbles: clusters.singleBubbles
                });

                // Load images
                loadBubbleImages(
                    processedData,
                    (loaded, total) => {
                        console.log(`${loaded}/${total} images loaded (${Math.round(loaded/total*100)}%)`);
                    },
                    (totalLoaded) => {
                        console.log(`All ${totalLoaded} images loaded`);
                    }
                );

                noDataMessage.style.display = 'none';
            } else {
                clearChart();
                noDataMessage.style.display = 'block';
            }
        }

        // Start animation
        const cleanup = animate(
            ctx,
            tooltip,
            canvas,
            state.clusters,
            state.singleBubbles,
            state.allBubbles,
            state.width,
            state.height,
            state.chartHeight,
            state.chartPaddingX,
            state.chartPaddingTop,
            PROTOCOL_COLORS,
            DEFAULT_PROTOCOL_COLOR,
            state.paddedMinDate,
            state.paddedMaxDate
        );

        // Load initial data
        loadInitialData();

        // Cleanup on page unload
        window.addEventListener('unload', () => {
            cleanup();
            cleanupImageToggle();
            cleanupCanvas();
        });
    </script>
</body>
</html> 